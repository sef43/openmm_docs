
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>12. Examples of OpenMM Integration &#8212; OpenMM User Guide c2d2539933259d85365b465b39e6c3113559e016 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="13. Testing and Validation of OpenMM" href="07_testing_validation.html" />
    <link rel="prev" title="11. Using OpenMM with Software Written in Languages Other than C++" href="05_languages_not_cpp.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="examples-of-openmm-integration">
<span id="id1"></span><h1><span class="section-number">12. </span>Examples of OpenMM Integration<a class="headerlink" href="#examples-of-openmm-integration" title="Permalink to this heading">¶</a></h1>
<section id="gromacs">
<h2><span class="section-number">12.1. </span>GROMACS<a class="headerlink" href="#gromacs" title="Permalink to this heading">¶</a></h2>
<p>GROMACS is a large, complex application written primarily in C.  The
considerations involved in adapting it to use OpenMM are likely to be similar to
those faced by developers of other existing applications.</p>
<p>The first principle we followed in adapting GROMACS was to keep all OpenMM-related
code isolated to just a few files, while modifying as little of the
existing GROMACS code as possible.  This minimized the risk of breaking existing
parts of the code, while making the OpenMM-related parts as easy to work with as
possible.  It also minimized the need for C code to invoke the C++ API.  (This
would not be an issue if we used the OpenMM C API wrapper, but that is less
convenient than the C++ API, and placing all of the OpenMM calls into separate
C++ files solves the problem equally well.)  Nearly all of the OpenMM-specific
code is contained in a single file, openmm_wrapper.cpp.  It defines four
functions which encapsulate all of the interaction between OpenMM and the rest
of GROMACS:</p>
<p><code class="code docutils literal notranslate"><span class="pre">openmm_init()</span></code>: As arguments, this function takes pointers to lots of
internal GROMACS data structures that describe the simulation to be run.  It
creates a System, Integrator, and Context based on them, then returns an opaque
reference to an object containing them.  That reference is an input argument to
all of the other functions defined in openmm_wrapper.cpp.  This allows
information to be passed between those functions without exposing it to the rest
of GROMACS.</p>
<p><code class="code docutils literal notranslate"><span class="pre">openmm_take_one_step()</span></code>: This calls <code class="code docutils literal notranslate"><span class="pre">step(1)</span></code> on the
Integrator that was created by <code class="code docutils literal notranslate"><span class="pre">openmm_init()</span></code>.</p>
<p><code class="code docutils literal notranslate"><span class="pre">openmm_copy_state()</span></code>: This calls <code class="code docutils literal notranslate"><span class="pre">getState()</span></code> on the
Context that was created by <code class="code docutils literal notranslate"><span class="pre">openmm_init()</span></code>, and then copies
information from the resulting State into various GROMACS data structures.  This
function is how state data generated by OpenMM is passed back to GROMACS for
output, analysis, etc.</p>
<p><code class="code docutils literal notranslate"><span class="pre">openmm_cleanup()</span></code>: This is called at the end of the simulation.  It
deletes all the objects that were created by <code class="code docutils literal notranslate"><span class="pre">openmm_init()</span></code>.</p>
<p>This set of functions defines the interactions between GROMACS and OpenMM:
copying information from the application to OpenMM, performing integration,
copying information from OpenMM back to the application, and freeing resources
at the end of the simulation.  While the details of their implementations are
specific to GROMACS, this overall pattern is fairly generic.  A similar set of
functions can be used for many other applications as well.</p>
</section>
<section id="tinker-openmm">
<h2><span class="section-number">12.2. </span>TINKER-OpenMM<a class="headerlink" href="#tinker-openmm" title="Permalink to this heading">¶</a></h2>
<p>TINKER is written primarily in Fortran, and uses common blocks extensively to
store application-wide parameters.  Rather than modify the TINKER build scripts
to allow C++ code, it was decided to use the OpenMM C API instead.  Despite
these differences, the overall approach used to add OpenMM support was very
similar to that used for GROMACS.</p>
<p>TINKER-OpenMM allows OpenMM to be used to calculate forces and energies and to
perform the integration in the main molecular dynamics loop. The only changes to
the TINKER source code are in the file <code class="code docutils literal notranslate"><span class="pre">dynamic.f</span></code> for the setup and
running of a simulation.  An added file, <code class="code docutils literal notranslate"><span class="pre">dynamic_openmm.c</span></code>, contains
the interface C code between TINKER and OpenMM.</p>
<p>The flow of the molecular dynamics simulation using OpenMM is as follows:</p>
<ol class="arabic simple">
<li><p>The TINKER code is used to read the AMOEBA parameter file,  the
<code class="code docutils literal notranslate"><span class="pre">*.xyz</span></code> and <code class="code docutils literal notranslate"><span class="pre">*.key</span></code> files.  It then parses the command-line
options.</p></li>
<li><p>The routine <code class="code docutils literal notranslate"><span class="pre">map_common_blocks_to_c_data_structs()</span></code> is
called to map the FORTRAN common blocks to C data structures used in setting the
parameters used by OpenMM.</p></li>
<li><p>The routine <code class="code docutils literal notranslate"><span class="pre">openmm_validate()</span></code> is called from
<code class="code docutils literal notranslate"><span class="pre">dynamic.f</span></code> before the main loop.  This routine checks that all required
options and settings obtained from the input in step (1) and common blocks in
step (2) are available.  If an option or setting is unsupported, the program
exits with an appropriate message.  The routine <code class="code docutils literal notranslate"><span class="pre">openmm_validate()</span></code>
and the other OpenMM interface methods are in the file
<code class="code docutils literal notranslate"><span class="pre">dynamic_openmm.c</span></code>.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">openmm_init()</span></code> is called to create the OpenMM System,
Integrator and Context objects..</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">openmm_take_steps()</span></code> is called to take a specified number
of time steps.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">openmm_update()</span></code> is then called to retrieve the state
(energies/positions/velocities) and populate the appropriate TINKER data
structures.  These values are converted from the OpenMM units of kJ/nm to kcal/Å
when populating the TINKER arrays.</p></li>
<li><p>Once the main loop has completed, the routine
<code class="code docutils literal notranslate"><span class="pre">openmm_cleanup()</span></code> is called to delete the OpenMM objects and release
resources being used on the GPU.</p></li>
</ol>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="05_languages_not_cpp.html" title="Previous document"><span class="section-number">11. </span>Using OpenMM with Software Written in Languages Other than C++</a>
        </li>
        <li>
          <a href="07_testing_validation.html" title="Next document"><span class="section-number">13. </span>Testing and Validation of OpenMM</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">OpenMM User Guide</h1>
    
  </a>
</p>










<script>
function report(value) {
    newlink = "http://docs.openmm.org/"+value+"/api-python/";
    location.href = newlink;
}
</script>
<div class="extra-nav-links">
These docs are for <a href="https://github.com/openmm/openmm/tree/c2d2539933259d85365b465b39e6c3113559e016">OpenMM version = 8.0.0.dev-c2d2539</a>
</div>
<div class="extra-nav-links">
You can change to a different version:
<select name="version" id="version_selector" onchange="report(this.value)">
    <option selected disabled>version</option>
    <option>development</option>
    <option>latest</option>
    <option>7.7.0</option>
    <option>7.6.0</option>
    <option>7.5.0</option>
    <option>7.4.0</option>
    <option>7.3.0</option>
    <option>7.2.0</option>
    <option>7.1.0</option>
</select>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="navigation-scrollbox">
    <div class="nav-toctree">
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../application.html">Part I: The OpenMM Application Layer</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../library.html">Part II: The OpenMM Library</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_introduction.html">7. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_compiling.html">8. Compiling OpenMM from Source Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_tutorials.html">9. OpenMM Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_platform_specifics.html">10. Platform-Specific Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_languages_not_cpp.html">11. Using OpenMM with Software Written in Languages Other than C++</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">12. Examples of OpenMM Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gromacs">12.1. GROMACS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tinker-openmm">12.2. TINKER-OpenMM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="07_testing_validation.html">13. Testing and Validation of OpenMM</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_amoeba_plugin.html">14. AMOEBA Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_rpmd_plugin.html">15. Ring Polymer Molecular Dynamics (RPMD) Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_drude_plugin.html">16. Drude Plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../theory.html">Part III: The Theory Behind OpenMM</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../zbibliography.html">22. Bibliography</a></li>
</ul>

    </div>
    
    <ul class="extra-nav-links">
        
        <li class="toctree-l1">
            <a href="https://openmm.org">
                OpenMM.org
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="../../developerguide/">
                Developer Guide
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="../../api-python/">
                Python API reference
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="../../api-c++/">
                C++ API reference
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://github.com/openmm">
                GitHub
            </a>
        </li>
        
    </ul>
    
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2008-2017, Stanford University.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/library/06_integration_examples.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>