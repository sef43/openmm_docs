
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>21. Other Features &#8212; OpenMM User Guide c2d2539933259d85365b465b39e6c3113559e016 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="22. Bibliography" href="../zbibliography.html" />
    <link rel="prev" title="20. Integrators" href="04_integrators.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="other-features">
<span id="id1"></span><h1><span class="section-number">21. </span>Other Features<a class="headerlink" href="#other-features" title="Permalink to this heading">¶</a></h1>
<section id="periodic-boundary-conditions">
<h2><span class="section-number">21.1. </span>Periodic Boundary Conditions<a class="headerlink" href="#periodic-boundary-conditions" title="Permalink to this heading">¶</a></h2>
<p>Many Force objects support periodic boundary conditions.  They act as if space
were tiled with infinitely repeating copies of the system, then compute the
forces acting on a single copy based on the infinite periodic copies.  In most
(but not all) cases, they apply a cutoff so that each particle only interacts
with a single copy of each other particle.</p>
<p>OpenMM supports triclinic periodic boxes.  This means the periodicity is defined
by three vectors, <span class="math notranslate nohighlight">\(\mathbf{a}\)</span>, <span class="math notranslate nohighlight">\(\mathbf{b}\)</span>, and
<span class="math notranslate nohighlight">\(\mathbf{c}\)</span>.  Given a particle position, the infinite periodic copies
of that particle are generated by adding vectors of the form
<span class="math notranslate nohighlight">\(i \mathbf{a}+j \mathbf{b}+k \mathbf{c}\)</span>, where <span class="math notranslate nohighlight">\(i\)</span>,
<span class="math notranslate nohighlight">\(j\)</span>, and <span class="math notranslate nohighlight">\(k\)</span> are arbitrary integers.</p>
<p>The periodic box vectors must be chosen to satisfy certain requirements.
Roughly speaking, <span class="math notranslate nohighlight">\(\mathbf{a}\)</span>, <span class="math notranslate nohighlight">\(\mathbf{b}\)</span>, and
<span class="math notranslate nohighlight">\(\mathbf{c}\)</span> need to “mostly” correspond to the x, y, and z axes.  They
must have the form</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\mathbf{a} = (a_x, 0, 0)\\\mathbf{b} = (b_x, b_y, 0)\\\mathbf{c} = (c_x, c_y, c_z)\end{aligned}\end{align} \]</div>
<p>It is always possible to put the box vectors into this form by rotating the
system until <span class="math notranslate nohighlight">\(\mathbf{a}\)</span> is parallel to x and <span class="math notranslate nohighlight">\(\mathbf{b}\)</span> lies in
the xy plane.</p>
<p>Furthermore, they must obey the following constraints:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}a_x &gt; 0, b_y &gt; 0, c_z &gt; 0\\a_x \ge 2 |b_x|\\a_x \ge 2 |c_x|\\b_y \ge 2 |c_y|\end{aligned}\end{align} \]</div>
<p>This effectively requires the box vectors to be specified in a particular
reduced form.  By forming combinations of box vectors (a process known as
“lattice reduction”), it is always possible to put them in this form without
changing the periodic system they represent.</p>
<p>These requirements have an important consequence: the periodic unit cell can
always be treated as an axis-aligned rectangular box of size
<span class="math notranslate nohighlight">\((a_x, b_y, c_z)\)</span>.  The remaining non-zero elements of the box vectors
cause the repeating copies of the system to be staggered relative to each other,
but they do not affect the shape or size of each copy.  The volume of the unit
cell is simply given by <span class="math notranslate nohighlight">\(a_x b_y c_z\)</span>.</p>
</section>
<section id="localenergyminimizer">
<h2><span class="section-number">21.2. </span>LocalEnergyMinimizer<a class="headerlink" href="#localenergyminimizer" title="Permalink to this heading">¶</a></h2>
<p>This provides an implementation of the L-BFGS optimization algorithm.
<span id="id2">[<a class="reference internal" href="../zbibliography.html#id29" title="Dong C. Liu and Jorge Nocedal. On the limited memory BFGS method for large scale optimization. Mathematical Programming, 45:503-528, 1989.">59</a>]</span>  Given a Context specifying initial particle positions, it
searches for a nearby set of positions that represent a local minimum of the
potential energy.  Distance constraints are enforced during minimization by
adding a harmonic restraining force to the potential function.  The strength of
the restraining force is steadily increased until the minimum energy
configuration satisfies all constraints to within the tolerance specified by the
Context’s Integrator.</p>
</section>
<section id="xmlserializer">
<h2><span class="section-number">21.3. </span>XMLSerializer<a class="headerlink" href="#xmlserializer" title="Permalink to this heading">¶</a></h2>
<p>This provides the ability to “serialize” a System, Force, Integrator, or State
object to a portable XML format, then reconstruct it again later.  When
serializing a System, the XML data contains a complete copy of the entire system
definition, including all Forces that have been added to it.</p>
<p>Here are some examples of uses for this class:</p>
<ol class="arabic simple">
<li><p>A model building utility could generate a System in memory, then serialize it
to a file on disk.  Other programs that perform simulation or analysis could
then reconstruct the model by simply loading the XML file.</p></li>
<li><p>When running simulations on a cluster, all model construction could be done
on a single node.  The Systems and Integrators could then be encoded as XML,
allowing them to be easily transmitted to other nodes.</p></li>
</ol>
<p>XMLSerializer is a templatized class that, in principle, can be used to
serialize any type of object.  At present, however, only System, Force,
Integrator, and State are supported.</p>
</section>
<section id="force-groups">
<h2><span class="section-number">21.4. </span>Force Groups<a class="headerlink" href="#force-groups" title="Permalink to this heading">¶</a></h2>
<p>It is possible to split the Force objects in a System into groups.  Those groups
can then be evaluated independently of each other.  This is done by calling
<code class="code docutils literal notranslate"><span class="pre">setForceGroup()</span></code> on the Force.  Some Force classes also
provide finer grained control over grouping.  For example, NonbondedForce allows
direct space computations to be in one group and reciprocal space computations
in a different group.</p>
<p>The most important use of force groups is for implementing multiple time step
algorithms with CustomIntegrator.  For example, you might evaluate the slowly
changing nonbonded interactions less frequently than the quickly changing bonded
ones.  This can be done by putting the slow and fast forces into separate
groups, then using a <code class="xref py py-class docutils literal notranslate"><span class="pre">MTSIntegrator</span></code> or <code class="xref py py-class docutils literal notranslate"><span class="pre">MTSLangevinIntegrator</span></code>
that evaluates the groups at different frequencies.</p>
<p>Another important use is to define forces that are not used when integrating
the equations of motion, but can still be queried efficiently.  To do this,
call <code class="code docutils literal notranslate"><span class="pre">setIntegrationForceGroups()</span></code> on the <code class="xref py py-class docutils literal notranslate"><span class="pre">Integrator</span></code>.  Any groups
omitted will be ignored during simulation, but can be queried at any time by
calling <code class="code docutils literal notranslate"><span class="pre">getState()</span></code>.</p>
</section>
<section id="virtual-sites">
<span id="id3"></span><h2><span class="section-number">21.5. </span>Virtual Sites<a class="headerlink" href="#virtual-sites" title="Permalink to this heading">¶</a></h2>
<p>A virtual site is a particle whose position is computed directly from the
positions of other particles, not by integrating the equations of motion.  An
important example is the “extra sites” present in 4 and 5 site water models.
These particles are massless, and therefore cannot be integrated.  Instead,
their positions are computed from the positions of the massive particles in the
water molecule.</p>
<p>Virtual sites are specified by creating a VirtualSite object, then telling the
System to use it for a particular particle.  The VirtualSite defines the rules
for computing its position.  It is an abstract class with subclasses for
specific types of rules.  They are:</p>
<ul class="simple">
<li><p>TwoParticleAverageSite: The virtual site location is computed as a weighted
average of the positions of two particles:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\mathbf{r}={w}_{1}\mathbf{r}_{1}+{w}_{2}\mathbf{r}_{2}\]</div>
<ul class="simple">
<li><p>ThreeParticleAverageSite: The virtual site location is computed as a weighted
average of the positions of three particles:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\mathbf{r}={w}_{1}\mathbf{r}_{1}+{w}_{2}\mathbf{r}_{2}+{w}_{3}\mathbf{r}_{3}\]</div>
<ul class="simple">
<li><p>OutOfPlaneSite: The virtual site location is computed as a weighted average
of the positions of three particles and the cross product of their relative
displacements:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\mathbf{r}=\mathbf{r}_{1}+{w}_{12}\mathbf{r}_{12}+{w}_{13}\mathbf{r}_{13}+{w}_\mathit{cross}\left(\mathbf{r}_{12}\times \mathbf{r}_{13}\right)\]</div>
<blockquote>
<div><p>where <span class="math notranslate nohighlight">\(\mathbf{r}_{12} = \mathbf{r}_{2}-\mathbf{r}_{1}\)</span> and
<span class="math notranslate nohighlight">\(\mathbf{r}_{13} = \mathbf{r}_{3}-\mathbf{r}_{1}\)</span>.  This allows
the virtual site to be located outside the plane of the three particles.</p>
</div></blockquote>
<ul class="simple">
<li><p>LocalCoordinatesSite: The locations of several other particles are used to compute a local
coordinate system, and the virtual site is placed at a fixed location in that coordinate
system.  The number of particles used to define the coordinate system is user defined.
The origin of the coordinate system and the directions of its x and y axes
are each specified as a weighted sum of the locations of the other particles:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\mathbf{o}={w}^{o}_{1}\mathbf{r}_{1} + {w}^{o}_{2}\mathbf{r}_{2} + ...\\\mathbf{dx}={w}^{x}_{1}\mathbf{r}_{1} + {w}^{x}_{2}\mathbf{r}_{2} + ...\\\mathbf{dy}={w}^{y}_{1}\mathbf{r}_{1} + {w}^{y}_{2}\mathbf{r}_{2} + ...\\\mathbf{dz}=\mathbf{dx}\times \mathbf{dy}\end{aligned}\end{align} \]</div>
<blockquote>
<div><p>These vectors are then used to construct a set of orthonormal coordinate axes as follows:</p>
</div></blockquote>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\mathbf{\hat{x}}=\mathbf{dx}/|\mathbf{dx}|\\\mathbf{\hat{z}}=\mathbf{dz}/|\mathbf{dz}|\\\mathbf{\hat{y}}=\mathbf{\hat{z}}\times \mathbf{\hat{x}}\end{aligned}\end{align} \]</div>
<blockquote>
<div><p>Finally, the position of the virtual site is set to</p>
</div></blockquote>
<div class="math notranslate nohighlight">
\[\mathbf{r}=\mathbf{o}+p_1\mathbf{\hat{x}}+p_2\mathbf{\hat{y}}+p_3\mathbf{\hat{z}}\]</div>
</section>
<section id="random-numbers-with-stochastic-integrators-and-forces">
<h2><span class="section-number">21.6. </span>Random Numbers with Stochastic Integrators and Forces<a class="headerlink" href="#random-numbers-with-stochastic-integrators-and-forces" title="Permalink to this heading">¶</a></h2>
<p>OpenMM includes many stochastic integrators and forces that make extensive use
of random numbers. It is impossible to generate truly random numbers on a
computer like you would with a dice roll or coin flip in real life—instead
programs rely on pseudo-random number generators (PRNGs) that take some sort of
initial “seed” value and steps through a sequence of seemingly random numbers.</p>
<p>The exact implementation of the PRNGs is not important (in fact, each platform
may have its own PRNG whose performance is optimized for that hardware).  What
<em>is</em> important, however, is that the PRNG must generate a uniform distribution
of random numbers between 0 and 1. Random numbers drawn from this distribution
can be manipulated to yield random integers in a desired range or even a random
number from a different type of probability distribution function (e.g., a
normal distribution).</p>
<p>What this means is that the random numbers used by integrators and forces within
OpenMM cannot have any discernible pattern to them.  Patterns can be induced in
PRNGs in two principal ways:</p>
<ol class="arabic simple">
<li><p>The PRNG uses a bad algorithm with a short period.</p></li>
<li><p>Two PRNGs are started using the same seed</p></li>
</ol>
<p>All PRNG algorithms in common use are periodic—that is their sequence of
random numbers repeats after a given <em>period</em>, defined by the number of “unique”
random numbers in the repeating pattern.  As long as this period is longer than
the total number of random numbers your application requires (preferably by
orders of magnitude), the first problem described above is avoided. All PRNGs
employed by OpenMM have periods far longer than any current simulation can cycle
through.</p>
<p>Point two is far more common in biomolecular simulation, and can result in very
strange artifacts that may be difficult to detect. For example, with Langevin
dynamics, two simulations that use the same sequence of random numbers appear to
synchronize in their global movements.<span id="id4">[<a class="reference internal" href="../zbibliography.html#id59" title="Blas P. Uberuaga, Marian Anghel, and Arthur F. Voter. Synchronization of trajectories in canonical molecular-dynamics simulations: observation, explanation, and exploitation. Journal of Chemical Physics, 120(14):6363–6374, 2004.">60</a>]</span><span id="id5">[<a class="reference internal" href="../zbibliography.html#id52" title="Daniel J. Sindhikara, Seonah Kim, Arthur F. Voter, and Adrian E. Roitberg. Bad Seeds Sprout Perilous Dynamics: Stochastic Thermostat Induced Trajectory Synchronization in Biomolecules. Journal of Chemical Theory and Computation, 5(6):1624–1631, April 2009.">61</a>]</span> It is therefore very important that the stochastic forces
and integrators in OpenMM generate unique sequences of pseudo-random numbers not
only within a single simulation, but between two different simulations of the
same system as well (including any restarts of previous simulations).</p>
<p>Every stochastic force and integrator that does (or could) make use of random
numbers has two instance methods attached to it: <code class="xref py py-meth docutils literal notranslate"><span class="pre">getRandomNumberSeed()</span></code>
and <code class="xref py py-meth docutils literal notranslate"><span class="pre">setRandomNumberSeed(int</span> <span class="pre">seed)()</span></code>. If you set a unique random seed for
two different simulations (or different forces/integrators if applicable),
OpenMM guarantees that the generated sequences of random numbers will be
different (by contrast, no guarantee is made that the same seed will result in
identical random number sequences).</p>
<p>Since breaking simulations up into pieces and/or running multiple replicates of
a system to obtain more complete statistics is common practice, a new strategy
has been employed for OpenMM versions 6.3 and later with the aim of trying to
ensure that each simulation will be started with a unique random seed. A random
seed value of 0 (the default) will cause a unique random seed to be generated
when a new <code class="xref py py-class docutils literal notranslate"><span class="pre">Context</span></code> is instantiated.</p>
<p>Prior to the introduction of this feature, deserializing a serialized
<code class="xref py py-class docutils literal notranslate"><span class="pre">System</span></code> XML file would result in each stochastic force or integrator
being assigned the same random seed as the original instance that was
serialized. If you use a <code class="xref py py-class docutils literal notranslate"><span class="pre">System</span></code> XML file generated by a version of
OpenMM older than 6.3 to start a new simulation, you should manually set the
random number seed of each stochastic force or integrator to 0 (or another
unique value).</p>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="04_integrators.html" title="Previous document"><span class="section-number">20. </span>Integrators</a>
        </li>
        <li>
          <a href="../zbibliography.html" title="Next document"><span class="section-number">22. </span>Bibliography</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">OpenMM User Guide</h1>
    
  </a>
</p>










<script>
function report(value) {
    newlink = "http://docs.openmm.org/"+value+"/api-python/";
    location.href = newlink;
}
</script>
<div class="extra-nav-links">
These docs are for <a href="https://github.com/openmm/openmm/tree/c2d2539933259d85365b465b39e6c3113559e016">OpenMM version = 8.0.0.dev-c2d2539</a>
</div>
<div class="extra-nav-links">
You can change to a different version:
<select name="version" id="version_selector" onchange="report(this.value)">
    <options selected disabled>version</option>
    <option>development</option>
    <option>latest</option>
    <option>7.7.0</option>
    <option>7.6.0</option>
    <option>7.5.0</option>
    <option>7.4.0</option>
    <option>7.3.0</option>
    <option>7.2.0</option>
    <option>7.1.0</option>
</select>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="navigation-scrollbox">
    <div class="nav-toctree">
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../application.html">Part I: The OpenMM Application Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../library.html">Part II: The OpenMM Library</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../theory.html">Part III: The Theory Behind OpenMM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_introduction.html">17. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_standard_forces.html">18. Standard Forces</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_custom_forces.html">19. Custom Forces</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_integrators.html">20. Integrators</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">21. Other Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#periodic-boundary-conditions">21.1. Periodic Boundary Conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#localenergyminimizer">21.2. LocalEnergyMinimizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#xmlserializer">21.3. XMLSerializer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#force-groups">21.4. Force Groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtual-sites">21.5. Virtual Sites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#random-numbers-with-stochastic-integrators-and-forces">21.6. Random Numbers with Stochastic Integrators and Forces</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../zbibliography.html">22. Bibliography</a></li>
</ul>

    </div>
    
    <ul class="extra-nav-links">
        
        <li class="toctree-l1">
            <a href="https://openmm.org">
                OpenMM.org
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="../../developerguide/">
                Developer Guide
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="../../api-python/">
                Python API reference
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="../../api-c++/">
                C++ API reference
            </a>
        </li>
        
        <li class="toctree-l1">
            <a href="https://github.com/openmm">
                GitHub
            </a>
        </li>
        
    </ul>
    
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2008-2017, Stanford University.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/theory/05_other_features.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>